# Step 2b. Inferring Cell Type Factors using Seurat

This example illustrates infering cell type factors using Seurat. This process contains two stops that require manual evaluation, including one at [step 2b.2](#step-2b2-manually-select-the-cutoffs) and the other at [step 2b.4](#step-2b4-manually-select-the-resolution-for-clustering). 

**Prefix**:

This documentation uses the following prefixes to illustrate input and output filenames, which are automatically assigned by the script. 

```bash
hexagon_prefix="${prefix}.hexagon.${sf}.d_${tw}"
train_prefix="${prefix}.${sf}.nF${nf}.d_${tw}.s_${ep}"    
```

* The `nf` will be determined in [step 2b.5](#step-2b5-prepare-a-count-matrix-with-the-selected-resolution).
* Details on variables used in above prefixes are in the [Job Configuration](./job_config.md).

## Step 2b.1 Data Evaluation
This step applies the 'Seurat_analysis.R' script in test mode for evaluation, which includes:

* Assessing counts of mitochondrial and hypothetical genes,
* Examining the distribution of the number of spatial barcodes per hexagon (nCount_RNA) and the number of genes detected per hexagon (Nfeature_RNA),
* Filtering the SGE with various nFeature_RNA thresholds — 50, 100, 200, 300, 400, 500, 750, and 1000 — and creating density plots to assess each threshold's efficacy

Input & Output
```bash
# Input:
${hexagon_sge_dir}/features.tsv.gz
${hexagon_sge_dir}/barcodes.tsv.gz
${hexagon_sge_dir}/matrix.mtx.gz

# Output: 
${output_dir}/${train_model}/Ncount_Nfeature_vln.png
${output_dir}/${train_model}/nFeature_RNA_dist.png
${output_dir}/${train_model}/nFeature_RNA_cutoff${cutoff}.png # for each cut off, including 50, 100, 200, 300, 400, 500, 750, and 1000
```

Commands:
```bash
$neda_dir/steps/step2b.1-Seurat-test-cutoff.sh $input_configfile
```

## Step 2b.2 Manually Selecting the Optimal nFeature_RNA Cutoff
Examine the density plots generated by [step 2b.1](#step-2b1-create-hexagonal-spatial-gene-expression-sge-matrix-and-test-different-cutoffs-for-nfeature_rna) to choose a nFeature_RNA cutoff, aiming to remove noise signals. For our example data, we applied a cut off of 500 for deep liver section dataset, and 100 for shallow liver section dataset as well as the minimal test dataset. It is optional to define x y ranges(`X_min`, `X_max`, `Y_min`, and `Y_max`). 

Add the following variables to the input configuration file. 

Example:
```bash
nFeature_RNA_cutoff=100         ## The cutoff for nFeature_RNA    
X_min=2.5e+06
X_max=1e+07
Y_min=1e+06
Y_max=6e+06
```

## Step 2b.3 Seurat Clustering Analysis
The step script starts with the removal of mitochondrial and hypothetical genes and the filtering of hexagons based on `nFeature_RNA_cutoff` and, when applied, X Y ranges. Subsequently, it applies sctransform normalization followed by dimensionality reduction through [Principal Component Analysis (PCA)](https://satijalab.org/seurat/reference/runpca) and [Uniform Manifold Approximation and Projection (UMAP)](https://satijalab.org/seurat/reference/runumap) embedding.

Next, the step script employs [`FindClusters`](https://satijalab.org/seurat/reference/findclusters) segregate hexagons into clusters utilizing a shared nearest neighbor (SNN) modularity optimization-based clustering algorithm. The argument `resolution` in [`FindClusters`](https://satijalab.org/seurat/reference/findclusters) determines the "granularity" of clusters, i.e., a higher resolution value yields more clusters. Thus, this step will examine the performance of a range of `resolutions`, including 0.25, 0.5, 0.75, 1, 1.25, 1.5, and 1.75. For each specified resolution, the script generates an UMAP for dimensionality reduction, a spatial plot to visualize the clusters and their spatial arrangement, and a Differential Expression (DE) file, detailing marker genes identified for each cluster.

Additionally, this step generates a metadata file containing information on the cluster assignment for each hexagon, and an RDS (R Data Serialization) file that stores the complete Seurat object with all the compiled data.

Input & Output
```bash
# Input: 
${output_dir}/${train_model}/features.tsv.gz
${output_dir}/${train_model}/barcodes.tsv.gz
${output_dir}/${train_model}/matrix.mtx.gz

# Output: 
${output_dir}/${train_model}/${prefix}_cutoff${nFeature_RNA_cutoff}_metadata.csv                # a metadata file
${output_dir}/${train_model}/${prefix}_cutoff${nFeature_RNA_cutoff}_SCT.RDS                     # an RDS file
${output_dir}/${train_model}/${prefix}_cutoff${nFeature_RNA_cutoff}_res${res}_DE.csv            # for each resolution (`$res`) including 0.25, 0.5, 0.75, 1, 1.25, 1.5, and 1.75
${output_dir}/${train_model}/${prefix}_cutoff${nFeature_RNA_cutoff}_res${res}_DimSpatial.png    # for each resolution (`$res`) including 0.25, 0.5, 0.75, 1, 1.25, 1.5, and 1.75
```

Commands:
```bash
$neda_dir/steps/step2b.3-Seurat-clustering.sh $input_configfile
```

## Step 2b.4 Manually Selecting the Optimal Clustering Resolution
Examine the UMAP and spatial plots from the [step 2b.3](#step-2b3-seurat-clustering-analysis) and choose the optimal resolution. Then, save this chosen resolution into the input configuration file as the `res_of_interest` variable. 


Example:
```bash
res_of_interest=1
```

## Step 2b.5 Preparing a Count Matrix
Transform the metadata into a count matrix to serve as the model matrix for the subsequent step. Additionally, the number of clusters from the model matrix will be obtained and assigned to the `nf` variable in the input configuration file.

Input & Output
```bash
# Input:
${output_dir}/${train_model}/features.tsv.gz
${output_dir}/${train_model}/barcodes.tsv.gz
${output_dir}/${train_model}/matrix.mtx.gz
${output_dir}/${train_model}/${prefix}_cutoff${nFeature_RNA_cutoff}_metadata.csv

# Output: 
${output_dir}/${train_model}/${train_prefix}.model_matrix.tsv.gz
```

Commands:
```bash
$neda_dir/steps/step2b.5-Seurat-count-matrix.sh $input_configfile
```
